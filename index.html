<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外勤人員打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .btn-press {
            transform: scale(0.98);
            transition: transform 0.1s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <header class="bg-indigo-600 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">外勤人員打卡系統</h1>
            <p id="current-time" class="text-sm opacity-90 mt-2">讀取時間中...</p>
        </header>

        <main class="p-6 md:p-8">
            <!-- 狀態顯示區 -->
            <div id="status-card" class="bg-gray-50 rounded-lg p-5 mb-6 text-center border">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">目前狀態</h2>
                <p id="current-status" class="text-2xl font-bold text-gray-800">尚未打卡</p>
                <div id="last-action-info" class="text-sm text-gray-500 mt-3" style="display: none;">
                    <p id="last-action-time"></p>
                    <p id="last-action-location" class="mt-1"></p>
                </div>
            </div>

            <!-- 打卡按鈕區 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="clock-in-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <span>上班打卡</span>
                </button>
                <button id="clock-out-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" x2="12" y1="9" y2="13"></line><line x1="12" x2="12.01" y1="17" y2="17"></line></svg>
                    <span>下班打卡</span>
                </button>
            </div>
            
            <!-- 訊息提示 -->
            <div id="message-box" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
                <span class="font-medium" id="message-content"></span>
            </div>

            <!-- 打卡紀錄 -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">今日打卡紀錄</h3>
                <div id="history-log" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                    <p id="no-record-msg" class="text-gray-500 text-center py-4">尚無紀錄</p>
                    <!-- 紀錄會動態插入此處 -->
                </div>
            </div>
        </main>
    </div>

<script>
    // DOM 元素
    const currentTimeEl = document.getElementById('current-time');
    const currentStatusEl = document.getElementById('current-status');
    const lastActionInfoEl = document.getElementById('last-action-info');
    const lastActionTimeEl = document.getElementById('last-action-time');
    const lastActionLocationEl = document.getElementById('last-action-location');
    const clockInBtn = document.getElementById('clock-in-btn');
    const clockOutBtn = document.getElementById('clock-out-btn');
    const historyLogEl = document.getElementById('history-log');
    const noRecordMsgEl = document.getElementById('no-record-msg');
    const messageBoxEl = document.getElementById('message-box');
    const messageContentEl = document.getElementById('message-content');
    const statusCardEl = document.getElementById('status-card');

    // 應用程式狀態
    let isClockedIn = false;
    let history = [];

    // 更新時間
    function updateTime() {
        const now = new Date();
        const options = {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false
        };
        currentTimeEl.textContent = now.toLocaleString('zh-TW', options);
    }

    // 顯示訊息
    function showMessage(message, type = 'info') {
        messageContentEl.textContent = message;
        messageBoxEl.className = 'p-4 mb-4 text-sm rounded-lg'; // Reset classes
        switch (type) {
            case 'success':
                messageBoxEl.classList.add('bg-green-100', 'text-green-800');
                break;
            case 'error':
                messageBoxEl.classList.add('bg-red-100', 'text-red-800');
                break;
            case 'loading':
                messageBoxEl.classList.add('bg-blue-100', 'text-blue-800');
                break;
        }
        messageBoxEl.classList.remove('hidden');
    }
    
    // 隱藏訊息
    function hideMessage() {
        messageBoxEl.classList.add('hidden');
    }

    // 更新UI狀態
    function updateUI() {
        if (isClockedIn) {
            currentStatusEl.textContent = '工作中';
            statusCardEl.classList.remove('border-gray-300');
            statusCardEl.classList.add('border-green-500', 'bg-green-50');
            currentStatusEl.classList.remove('text-gray-800');
            currentStatusEl.classList.add('text-green-600');
            clockInBtn.disabled = true;
            clockOutBtn.disabled = false;
        } else {
            currentStatusEl.textContent = history.length > 0 ? '已下班' : '尚未打卡';
            statusCardEl.classList.remove('border-green-500', 'bg-green-50');
            statusCardEl.classList.add('border-gray-300', 'bg-gray-50');
            currentStatusEl.classList.remove('text-green-600');
            currentStatusEl.classList.add('text-gray-800');
            clockInBtn.disabled = false;
            clockOutBtn.disabled = true;
        }

        // 更新最後操作資訊
        const lastAction = history[history.length - 1];
        if (lastAction) {
            lastActionInfoEl.style.display = 'block';
            lastActionTimeEl.textContent = `時間：${lastAction.time}`;
            lastActionLocationEl.innerHTML = `地點：<a href="${lastAction.mapLink}" target="_blank" class="text-indigo-600 hover:underline">點我查看地圖</a>`;
        } else {
            lastActionInfoEl.style.display = 'none';
        }
    }
    
    // 渲染打卡紀錄
    function renderHistory() {
        if (history.length === 0) {
            noRecordMsgEl.style.display = 'block';
            historyLogEl.innerHTML = '';
            historyLogEl.appendChild(noRecordMsgEl);
        } else {
            noRecordMsgEl.style.display = 'none';
            historyLogEl.innerHTML = '';
            history.slice().reverse().forEach(item => {
                const logItem = document.createElement('div');
                logItem.className = 'bg-gray-50 p-3 rounded-lg border flex justify-between items-center';
                const typeText = item.type === 'in' ? '上班' : '下班';
                const typeColor = item.type === 'in' ? 'text-green-600' : 'text-red-600';
                
                logItem.innerHTML = `
                    <div>
                        <p class="font-semibold"><span class="${typeColor} font-bold">${typeText}</span> - ${item.time}</p>
                        <p class="text-xs text-gray-500 mt-1">經緯度: ${item.coords.latitude.toFixed(5)}, ${item.coords.longitude.toFixed(5)}</p>
                    </div>
                    <a href="${item.mapLink}" target="_blank" class="text-sm text-indigo-500 hover:text-indigo-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </a>
                `;
                historyLogEl.appendChild(logItem);
            });
        }
    }
    
    // 處理打卡動作
    function handleClockAction(type) {
        hideMessage();
        showMessage('正在取得您的GPS位置...', 'loading');
        
        const actionBtn = type === 'in' ? clockInBtn : clockOutBtn;
        actionBtn.disabled = true; // 防止重複點擊

        if (!navigator.geolocation) {
            showMessage('您的瀏覽器不支援GPS定位功能。', 'error');
            actionBtn.disabled = false;
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                
                const newRecord = {
                    type: type,
                    timestamp: now,
                    time: timeString,
                    coords: { latitude, longitude },
                    mapLink: `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}#map=18/${latitude}/${longitude}`
                };
                
                history.push(newRecord);
                isClockedIn = (type === 'in');
                
                updateUI();
                renderHistory();
                
                const actionText = type === 'in' ? '上班' : '下班';
                showMessage(`${actionText}打卡成功！`, 'success');
            },
            (error) => {
                let errorMessage = '無法取得位置，原因：';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += '您拒絕了位置存取權限。請至瀏覽器設定開啟。';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += '無法偵測到您的位置資訊。';
                        break;
                    case error.TIMEOUT:
                        errorMessage += '取得位置資訊超時。';
                        break;
                    default:
                        errorMessage += '發生未知錯誤。';
                        break;
                }
                showMessage(errorMessage, 'error');
                actionBtn.disabled = false; // 失敗時重新啟用按鈕
                updateUI(); // 確保按鈕狀態正確
            },
            {
                enableHighAccuracy: true, // 盡可能使用高精確度
                timeout: 10000, // 10秒超時
                maximumAge: 0 // 不使用快取
            }
        );
    }
    
    // 按鈕點擊動畫
    function addPressEffect(button) {
        button.addEventListener('mousedown', () => button.classList.add('btn-press'));
        button.addEventListener('mouseup', () => button.classList.remove('btn-press'));
        button.addEventListener('mouseleave', () => button.classList.remove('btn-press'));
        button.addEventListener('touchstart', () => button.classList.add('btn-press'));
        button.addEventListener('touchend', () => button.classList.remove('btn-press'));
    }

    // 事件監聽
    clockInBtn.addEventListener('click', () => handleClockAction('in'));
    clockOutBtn.addEventListener('click', () => handleClockAction('out'));
    addPressEffect(clockInBtn);
    addPressEffect(clockOutBtn);

    // 初始化
    function initialize() {
        setInterval(updateTime, 1000);
        updateTime();
        updateUI();
        renderHistory();
    }

    initialize();
</script>
</body>
</html>
